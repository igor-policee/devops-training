---

- name: Gather the package facts
  ansible.builtin.package_facts:
    manager: auto

- name: Result -> gitlab-runner
  ansible.builtin.debug:
    msg: gitlab-runner found
  when: "'gitlab-runner' in ansible_facts.packages"

- name: Result -> gitlab-runner
  ansible.builtin.debug:
    msg: gitlab-runner NOT found
  when: "'gitlab-runner' not in ansible_facts.packages"

- block:
    - name: Install -> GitLab runner from the official repository
      ansible.builtin.shell: >-
        curl -L "https://packages.gitlab.com/install/repositories/runner/gitlab-runner/script.deb.sh" | sudo bash

    - name: Install -> GitLab runner from the official repository
      ansible.builtin.apt:
        name: gitlab-runner
        state: latest
        update_cache: true
      notify:
        Start and enable service -> gitlab-runner

  when: "'gitlab-runner' not in ansible_facts.packages"

- name: Check GitLab Runner registration (Linux)
  ansible.builtin.shell: |-
    cat /etc/gitlab-runner/config.toml | egrep {{ gitlab_url }} || echo 'runner not registered'
  register: check_result

- name: Add user 'gitlab-runner' -> 'docker,admin'
  ansible.builtin.user:
    name: gitlab-runner
    groups: gitlab-runner,docker,admin

- name: DEBUG
  ansible.builtin.debug:
    var: check_result['stdout']

- name: Register GitLab Runner (Linux)
  ansible.builtin.shell: >-
    gitlab-runner register
    --non-interactive
    --url {{ gitlab_url }}
    --registration-token {{ gitlab_reg_token }}
    --executor "shell"
    --docker-image alpine:latest
    --description "runner-linux"
    --tag-list linux
    --run-untagged=true
    --locked="false"
    --access-level="not_protected"
  when: check_result['stdout'] == 'runner not registered'